<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - HKO LIMO</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        /* Login Screen */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; }
        .login-box h1 { color: #667eea; font-size: 28px; margin-bottom: 10px; text-align: center; }
        .login-box p { color: #666; text-align: center; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; margin-bottom: 20px; transition: border-color 0.3s; }
        .login-box input:focus { outline: none; border-color: #667eea; }
        .login-box button { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.3s; }
        .login-box button:hover { transform: translateY(-2px); }
        .error-message { color: #e74c3c; font-size: 14px; margin-top: 10px; text-align: center; }
        .hidden { display: none !important; }
        
        /* Dashboard */
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #667eea; font-size: 24px; }
        .header button { padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        /* Tabs */
        .tabs { background: white; margin: 20px 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .tab-buttons { display: flex; border-bottom: 2px solid #f0f0f0; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 120px; padding: 18px; background: white; border: none; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; transition: all 0.3s; white-space: nowrap; }
        .tab-btn.active { color: #667eea; border-bottom: 3px solid #667eea; background: #f8f9ff; }
        .tab-btn:hover { background: #f8f9ff; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        
        /* Table */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        thead { background: #667eea; color: white; }
        th { padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        tbody tr:hover { background: #f8f9ff; }
        
        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .action-btns { display: flex; gap: 10px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #333; font-size: 22px; }
        .close-btn { font-size: 28px; cursor: pointer; color: #999; background: none; border: none; padding: 0; width: 30px; height: 30px; }
        .close-btn:hover { color: #333; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; padding-top: 20px; border-top: 2px solid #f0f0f0; }
        
        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .action-bar { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Pricing Section */
        .pricing-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
        .pricing-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .price-label { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h1>üöó HKO LIMO</h1>
            <p>Admin Dashboard</p>
            <input type="password" id="passwordInput" placeholder="Enter admin password">
            <button onclick="login()">Login</button>
            <div id="loginError" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="header">
            <h1>üöó HKO LIMO Admin Dashboard</h1>
            <button onclick="logout()">Logout</button>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('bookings')">üìã Bookings</button>
                <button class="tab-btn" onclick="switchTab('drivers')">üöó Drivers</button>
                <button class="tab-btn" onclick="switchTab('companies')">üè¢ Companies</button>
                <button class="tab-btn" onclick="switchTab('users')">üë• Users</button>
                <button class="tab-btn" onclick="switchTab('analytics')">üìä Analytics</button>
            </div>

            <!-- Bookings Tab -->
            <div id="bookingsTab" class="tab-content active">
                <h2 style="margin-bottom: 20px;">All Bookings</h2>
                <div id="bookingsLoading" class="loading"><div class="spinner"></div><p>Loading bookings...</p></div>
                <div id="bookingsTableContainer" class="table-container hidden">
                    <table id="bookingsTable">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Customer</th>
                                <th>Date & Time</th>
                                <th>Service</th>
                                <th>Vehicle</th>
                                <th>Status</th>
                                <th>Driver</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Drivers Tab -->
            <div id="driversTab" class="tab-content">
                <div class="action-bar">
                    <h2>Drivers Management</h2>
                    <button class="btn btn-primary" onclick="showAddDriverModal()">+ Add Driver</button>
                </div>
                <div id="driversLoading" class="loading"><div class="spinner"></div><p>Loading drivers...</p></div>
                <div id="driversTableContainer" class="table-container hidden">
                    <table id="driversTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Vehicle Type</th>
                                <th>License Plate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Companies Tab -->
            <div id="companiesTab" class="tab-content">
                <div class="action-bar">
                    <h2>Companies Management</h2>
                    <button class="btn btn-primary" onclick="showAddCompanyModal()">+ Add Company</button>
                </div>
                <div id="companiesLoading" class="loading"><div class="spinner"></div><p>Loading companies...</p></div>
                <div id="companiesTableContainer" class="table-container hidden">
                    <table id="companiesTable">
                        <thead>
                            <tr>
                                <th>Company Name</th>
                                <th>Contact Person</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="companiesTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <div class="action-bar">
                    <h2>Users Management</h2>
                    <button class="btn btn-primary" onclick="showAddUserModal()">+ Add User</button>
                </div>
                <div id="usersLoading" class="loading"><div class="spinner"></div><p>Loading users...</p></div>
                <div id="usersTableContainer" class="table-container hidden">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <h2 style="margin-bottom: 20px;">üìä Dashboard Analytics</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="color: #999; font-size: 12px; margin-bottom: 8px;">TOTAL BOOKINGS</div>
                        <div id="totalBookings" style="font-size: 36px; font-weight: 600; color: #667eea;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="color: #999; font-size: 12px; margin-bottom: 8px;">TOTAL REVENUE</div>
                        <div id="totalRevenue" style="font-size: 36px; font-weight: 600; color: #27ae60;">$0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="color: #999; font-size: 12px; margin-bottom: 8px;">ACTIVE DRIVERS</div>
                        <div id="totalDrivers" style="font-size: 36px; font-weight: 600; color: #667eea;">0</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="color: #999; font-size: 12px; margin-bottom: 8px;">TOTAL COMPANIES</div>
                        <div id="totalCompanies" style="font-size: 36px; font-weight: 600; color: #667eea;">0</div>
                    </div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Top Companies by Revenue</h3>
                    <table style="width: 100%; font-size: 14px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #f0f0f0;">
                                <th style="text-align: left; padding: 10px 0;">Company Name</th>
                                <th style="text-align: right; padding: 10px 0;">Bookings</th>
                                <th style="text-align: right; padding: 10px 0;">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="topCompaniesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Modal -->
    <div id="driverModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="driverModalTitle">Add Driver</h2>
                <button class="close-btn" onclick="closeDriverModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="driverForm">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="driverName" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="driverPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Vehicle Type *</label>
                        <select id="driverVehicle" required>
                            <option value="">-- Select Vehicle --</option>
                            <option value="s-class">Mercedes S-Class</option>
                            <option value="v-class">Mercedes V-Class (7-seater)</option>
                            <option value="alphard">Toyota Alphard/Vellfire (7-seater)</option>
                            <option value="hiace">Toyota Hiace (13-seater)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>License Plate *</label>
                        <input type="text" id="driverLicense" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDriverModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDriver()">Save Driver</button>
            </div>
        </div>
    </div>

    <!-- Company Modal -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="companyModalTitle">Add Company</h2>
                <button class="close-btn" onclick="closeCompanyModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="companyForm">
                    <div class="form-group">
                        <label>Company Name *</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>Contact Person *</label>
                        <input type="text" id="companyContact" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="companyEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" id="companyPhone" required>
                    </div>
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: #333;">üí∞ Custom Pricing</h4>
                        <div class="form-group">
                            <label>Pricing Type *</label>
                            <select id="pricingType" onchange="updatePricingDisplay()">
                                <option value="default">Use Default Pricing</option>
                                <option value="multiplier">Percentage Markup/Discount</option>
                                <option value="custom">Custom Prices</option>
                            </select>
                        </div>
                        <div id="pricingMultiplier" style="display: none;">
                            <div class="form-group">
                                <label>Adjustment % (e.g., 20 for 20% markup, -10 for 10% discount)</label>
                                <input type="number" id="multiplierValue" placeholder="0" step="0.1">
                            </div>
                        </div>
                        <div id="pricingCustom" style="display: none;">
                            <div class="pricing-grid">
                                <div>
                                    <label class="price-label">Mercedes S-Class</label>
                                    <input type="number" id="price-s-class" placeholder="150" step="0.01">
                                </div>
                                <div>
                                    <label class="price-label">Mercedes V-Class</label>
                                    <input type="number" id="price-v-class" placeholder="180" step="0.01">
                                </div>
                                <div>
                                    <label class="price-label">Toyota Alphard</label>
                                    <input type="number" id="price-alphard" placeholder="180" step="0.01">
                                </div>
                                <div>
                                    <label class="price-label">Toyota Hiace</label>
                                    <input type="number" id="price-hiace" placeholder="200" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCompanyModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCompany()">Save Company</button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add User</h2>
                <button class="close-btn" onclick="closeUserModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Company *</label>
                        <select id="userCompany" required>
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDy7z9suF_bpLI7pW4X9ofsZpfmEMc7Eeo",
            authDomain: "hkolimo-firebase.firebaseapp.com",
            projectId: "hkolimo-firebase",
            storageBucket: "hkolimo-firebase.firebasestorage.app",
            messagingSenderId: "1012271101382",
            appId: "1:1012271101382:web:fc922a415deadf277a2ec7"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ADMIN_PASSWORD = "HKOadmin2025!";
        let allBookings = [];
        let allDrivers = [];
        let allCompanies = [];
        let allUsers = [];
        let editingDriverId = null;
        let editingCompanyId = null;
        let editingUserId = null;

        // LOGIN
        function login() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                loadBookings();
                loadDrivers();
                loadCompanies();
                loadUsers();
                loadAnalytics();
            } else {
                errorDiv.textContent = 'Incorrect password. Please try again.';
                errorDiv.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') login();
                });
            }
        });

        // LOGOUT
        function logout() {
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('loginError').classList.add('hidden');
        }

        // TAB SWITCHING
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'analytics') loadAnalytics();
        }

        // BOOKINGS
        function loadBookings() {
            const loadingDiv = document.getElementById('bookingsLoading');
            const tableContainer = document.getElementById('bookingsTableContainer');
            
            try {
                db.collection('bookings').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                    allBookings = [];
                    snapshot.forEach(doc => {
                        allBookings.push({ id: doc.id, ...doc.data() });
                    });
                    displayBookings();
                    loadingDiv.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                });
            } catch (error) {
                console.error('Error loading bookings:', error);
            }
        }

        function displayBookings() {
            const tbody = document.getElementById('bookingsTableBody');
            tbody.innerHTML = '';
            if (allBookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">No bookings found</td></tr>';
                return;
            }
            allBookings.forEach(booking => {
                const row = document.createElement('tr');
                const driverName = booking.driver ? booking.driver.name : '--';
                const totalAmount = booking.totalAmount || 0;
                row.innerHTML = `
                    <td>${booking.id}</td>
                    <td>${booking.customerName || '--'}</td>
                    <td>${new Date(booking.createdAt?.toDate()).toLocaleString()}</td>
                    <td>${booking.serviceType || '--'}</td>
                    <td>${booking.vehicleType || '--'}</td>
                    <td>${booking.status || 'pending'}</td>
                    <td>${driverName}</td>
                    <td>$${parseFloat(totalAmount).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // DRIVERS
        function loadDrivers() {
            const loadingDiv = document.getElementById('driversLoading');
            const tableContainer = document.getElementById('driversTableContainer');
            
            try {
                db.collection('drivers').onSnapshot(snapshot => {
                    allDrivers = [];
                    snapshot.forEach(doc => {
                        allDrivers.push({ id: doc.id, ...doc.data() });
                    });
                    displayDrivers();
                    loadingDiv.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                });
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }

        function displayDrivers() {
            const tbody = document.getElementById('driversTableBody');
            tbody.innerHTML = '';
            if (allDrivers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No drivers found</td></tr>';
                return;
            }
            allDrivers.forEach(driver => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${driver.name}</td>
                    <td>${driver.phone}</td>
                    <td>${driver.vehicleType || '--'}</td>
                    <td>${driver.licensePlate}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="editDriver('${driver.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDriver('${driver.id}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddDriverModal() {
            editingDriverId = null;
            document.getElementById('driverModalTitle').textContent = 'Add Driver';
            document.getElementById('driverForm').reset();
            document.getElementById('driverModal').classList.add('active');
        }

        function editDriver(driverId) {
            const driver = allDrivers.find(d => d.id === driverId);
            if (!driver) return;
            editingDriverId = driverId;
            document.getElementById('driverModalTitle').textContent = 'Edit Driver';
            document.getElementById('driverName').value = driver.name;
            document.getElementById('driverPhone').value = driver.phone;
            document.getElementById('driverVehicle').value = driver.vehicleType;
            document.getElementById('driverLicense').value = driver.licensePlate;
            document.getElementById('driverModal').classList.add('active');
        }

        function closeDriverModal() {
            document.getElementById('driverModal').classList.remove('active');
            editingDriverId = null;
        }

        function saveDriver() {
            const name = document.getElementById('driverName').value;
            const phone = document.getElementById('driverPhone').value;
            const vehicleType = document.getElementById('driverVehicle').value;
            const licensePlate = document.getElementById('driverLicense').value;

            if (!name || !phone || !vehicleType || !licensePlate) {
                alert('Please fill all fields');
                return;
            }

            const driverData = { name, phone, vehicleType, licensePlate };

            const promise = editingDriverId 
                ? db.collection('drivers').doc(editingDriverId).update(driverData)
                : db.collection('drivers').add(driverData);

            promise.then(() => {
                alert(editingDriverId ? 'Driver updated!' : 'Driver added!');
                closeDriverModal();
            }).catch(error => alert('Error: ' + error.message));
        }

        function deleteDriver(driverId) {
            if (confirm('Delete this driver?')) {
                db.collection('drivers').doc(driverId).delete().then(() => {
                    alert('Driver deleted!');
                }).catch(error => alert('Error: ' + error.message));
            }
        }

        // COMPANIES - WITH PRICING
        function loadCompanies() {
            const loadingDiv = document.getElementById('companiesLoading');
            const tableContainer = document.getElementById('companiesTableContainer');
            
            try {
                db.collection('companies').onSnapshot(snapshot => {
                    allCompanies = [];
                    snapshot.forEach(doc => {
                        allCompanies.push({ id: doc.id, ...doc.data() });
                    });
                    displayCompanies();
                    populateCompanySelect();
                    loadingDiv.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                });
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        function displayCompanies() {
            const tbody = document.getElementById('companiesTableBody');
            tbody.innerHTML = '';
            if (allCompanies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No companies found</td></tr>';
                return;
            }
            allCompanies.forEach(company => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${company.name}</td>
                    <td>${company.contactPerson || '--'}</td>
                    <td>${company.email || '--'}</td>
                    <td>${company.phone || '--'}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="editCompany('${company.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCompany('${company.id}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddCompanyModal() {
            editingCompanyId = null;
            document.getElementById('companyModalTitle').textContent = 'Add Company';
            document.getElementById('companyForm').reset();
            document.getElementById('pricingType').value = 'default';
            updatePricingDisplay();
            document.getElementById('companyModal').classList.add('active');
        }

        function editCompany(companyId) {
            const company = allCompanies.find(c => c.id === companyId);
            if (!company) return;
            editingCompanyId = companyId;
            document.getElementById('companyModalTitle').textContent = 'Edit Company';
            document.getElementById('companyName').value = company.name;
            document.getElementById('companyContact').value = company.contactPerson || '';
            document.getElementById('companyEmail').value = company.email || '';
            document.getElementById('companyPhone').value = company.phone || '';
            
            // Load pricing info
            const pricing = company.pricing || { type: 'default' };
            document.getElementById('pricingType').value = pricing.type || 'default';
            if (pricing.type === 'multiplier') {
                document.getElementById('multiplierValue').value = pricing.value || 0;
            } else if (pricing.type === 'custom') {
                document.getElementById('price-s-class').value = pricing['s-class'] || 150;
                document.getElementById('price-v-class').value = pricing['v-class'] || 180;
                document.getElementById('price-alphard').value = pricing['alphard'] || 180;
                document.getElementById('price-hiace').value = pricing['hiace'] || 200;
            }
            updatePricingDisplay();
            document.getElementById('companyModal').classList.add('active');
        }

        function updatePricingDisplay() {
            const type = document.getElementById('pricingType').value;
            document.getElementById('pricingMultiplier').style.display = type === 'multiplier' ? 'block' : 'none';
            document.getElementById('pricingCustom').style.display = type === 'custom' ? 'block' : 'none';
        }

        function closeCompanyModal() {
            document.getElementById('companyModal').classList.remove('active');
            editingCompanyId = null;
        }

        function saveCompany() {
            const name = document.getElementById('companyName').value;
            const contactPerson = document.getElementById('companyContact').value;
            const email = document.getElementById('companyEmail').value;
            const phone = document.getElementById('companyPhone').value;
            const pricingType = document.getElementById('pricingType').value;

            if (!name || !contactPerson || !email || !phone) {
                alert('Please fill all fields');
                return;
            }

            let companyData = { name, contactPerson, email, phone };

            // Handle pricing
            if (pricingType === 'multiplier') {
                companyData.pricing = {
                    type: 'multiplier',
                    value: parseFloat(document.getElementById('multiplierValue').value) || 0
                };
            } else if (pricingType === 'custom') {
                companyData.pricing = {
                    type: 'custom',
                    's-class': parseFloat(document.getElementById('price-s-class').value) || 150,
                    'v-class': parseFloat(document.getElementById('price-v-class').value) || 180,
                    'alphard': parseFloat(document.getElementById('price-alphard').value) || 180,
                    'hiace': parseFloat(document.getElementById('price-hiace').value) || 200
                };
            } else {
                companyData.pricing = { type: 'default' };
            }

            const promise = editingCompanyId 
                ? db.collection('companies').doc(editingCompanyId).update(companyData)
                : db.collection('companies').add(companyData);

            promise.then(() => {
                alert(editingCompanyId ? 'Company updated!' : 'Company added!');
                closeCompanyModal();
            }).catch(error => alert('Error: ' + error.message));
        }

        function deleteCompany(companyId) {
            if (confirm('Delete this company?')) {
                db.collection('companies').doc(companyId).delete().then(() => {
                    alert('Company deleted!');
                }).catch(error => alert('Error: ' + error.message));
            }
        }

        function populateCompanySelect() {
            const select = document.getElementById('userCompany');
            select.innerHTML = '<option value="">-- Select Company --</option>';
            allCompanies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                select.appendChild(option);
            });
        }

        // USERS
        function loadUsers() {
            const loadingDiv = document.getElementById('usersLoading');
            const tableContainer = document.getElementById('usersTableContainer');
            
            try {
                db.collection('users').onSnapshot(snapshot => {
                    allUsers = [];
                    snapshot.forEach(doc => {
                        allUsers.push({ id: doc.id, ...doc.data() });
                    });
                    displayUsers();
                    loadingDiv.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            if (allUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No users found</td></tr>';
                return;
            }
            allUsers.forEach(user => {
                const company = allCompanies.find(c => c.id === user.companyId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${company ? company.name : '--'}</td>
                    <td>Manager</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddUserModal() {
            editingUserId = null;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.add('active');
        }

        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            editingUserId = userId;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userCompany').value = user.companyId || '';
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            editingUserId = null;
        }

        function saveUser() {
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const companyId = document.getElementById('userCompany').value;

            if (!name || !email || !companyId) {
                alert('Please fill all fields');
                return;
            }

            const userData = { name, email, companyId, role: 'manager' };

            const promise = editingUserId 
                ? db.collection('users').doc(editingUserId).update(userData)
                : db.collection('users').add(userData);

            promise.then(() => {
                alert(editingUserId ? 'User updated!' : 'User added!');
                closeUserModal();
            }).catch(error => alert('Error: ' + error.message));
        }

        function deleteUser(userId) {
            if (confirm('Delete this user?')) {
                db.collection('users').doc(userId).delete().then(() => {
                    alert('User deleted!');
                }).catch(error => alert('Error: ' + error.message));
            }
        }

        // ANALYTICS
        function loadAnalytics() {
            // Total bookings
            document.getElementById('totalBookings').textContent = allBookings.length;
            
            // Total revenue
            const totalRevenue = allBookings.reduce((sum, booking) => sum + (parseFloat(booking.totalAmount) || 0), 0);
            document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            
            // Total drivers
            document.getElementById('totalDrivers').textContent = allDrivers.length;
            
            // Total companies
            document.getElementById('totalCompanies').textContent = allCompanies.length;
            
            // Top companies by revenue
            const companyRevenue = {};
            const companyBookings = {};
            allBookings.forEach(booking => {
                const company = booking.companyId || 'Direct';
                companyRevenue[company] = (companyRevenue[company] || 0) + (parseFloat(booking.totalAmount) || 0);
                companyBookings[company] = (companyBookings[company] || 0) + 1;
            });
            
            const topCompanies = Object.keys(companyRevenue).sort((a, b) => companyRevenue[b] - companyRevenue[a]).slice(0, 5);
            const tbody = document.getElementById('topCompaniesBody');
            tbody.innerHTML = '';
            
            topCompanies.forEach(companyId => {
                const company = allCompanies.find(c => c.id === companyId);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="padding: 10px 0;">${company ? company.name : 'Direct Booking'}</td>
                    <td style="text-align: right; padding: 10px 0;">${companyBookings[companyId]}</td>
                    <td style="text-align: right; padding: 10px 0;">$${companyRevenue[companyId].toFixed(2)}</td>
                `;
            });
        }
    </script>
</body>
</html>
